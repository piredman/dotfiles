#!/usr/bin/env bash

set -euo pipefail

# =============================================================================
# CONSTANTS
# =============================================================================

readonly PACMAN_CONF="/etc/pacman.conf"
readonly BACKUP_SUFFIX=".backup.$(date +%Y%m%d_%H%M%S)"

# =============================================================================
# FUNCTIONS
# =============================================================================

_ensure_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "✗ Must run as root" >&2
        exit 1
    fi
}

_backup_config() {
    cp "$PACMAN_CONF" "${PACMAN_CONF}${BACKUP_SUFFIX}"
}

_is_multilib_enabled() {
    grep -q "^\[multilib\]" "$PACMAN_CONF"
}

_verify_changes() {
    if _is_multilib_enabled; then
        echo "✓ Multilib enabled"
    else
        echo "✗ Failed to enable multilib" >&2
        exit 1
    fi
}

# =============================================================================
# MAIN EXECUTION
# =============================================================================

_ensure_root

if _is_multilib_enabled; then
    echo "✓ Multilib already enabled"
    exit 0
fi

_backup_config

if grep -q "^#\[multilib\]" "$PACMAN_CONF"; then
    sed -i '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ {
        s/^#\[multilib\]/[multilib]/
        s/^#Include = \/etc\/pacman.d\/mirrorlist/Include = \/etc\/pacman.d\/mirrorlist/
    }' "$PACMAN_CONF"
else
    echo "" >>"$PACMAN_CONF"
    echo "[multilib]" >>"$PACMAN_CONF"
    echo "Include = /etc/pacman.d/mirrorlist" >>"$PACMAN_CONF"
fi

_verify_changes
