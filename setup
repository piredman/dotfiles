#!/usr/bin/env bash

export LIB_DIR="$HOME/.local/lib/bash"
export DOTFILES_DIR="$HOME/dotfiles"
export BACKUP_DIR="$HOME/backup"

export SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/install/lib/install-utils"
source "$SCRIPT_DIR/install/lib/symlink-utils"
source "$SCRIPT_DIR/install/lib/package-utils"
source "$SCRIPT_DIR/zsh/scripts/shell-utils"

check_prerequisites || exit 1
validate_environment || exit 1

print_section "Setting Up Library Links"
create_symlink "$DOTFILES_DIR/install/lib/install-utils" "$LIB_DIR/install-utils" ""
create_symlink "$DOTFILES_DIR/install/lib/symlink-utils" "$LIB_DIR/symlink-utils" ""
create_symlink "$DOTFILES_DIR/install/lib/package-utils" "$LIB_DIR/package-utils" ""
create_symlink "$DOTFILES_DIR/zsh/scripts/shell-utils" "$LIB_DIR/shell-utils" ""

print_section "Configuring Pacman"
if ! run_script "$SCRIPT_DIR/install/scripts/check-multilib" >/dev/null 2>&1; then
    print_step "Enabling multilib repository"
    run_sudo_script "$SCRIPT_DIR/install/scripts/enable-multilib" >/dev/null 2>&1
    sudo pacman -Syy >/dev/null 2>&1
    print_success "Multilib enabled"
else
    print_success "Multilib already enabled"
fi

print_section "Installing Core Packages"
mapfile -t packages < <(load_package_config "$SCRIPT_DIR/install/config/core-packages.conf")
install_packages "${packages[@]}"

print_section "Configuring User Groups"
mapfile -t groups < <(load_group_config "$SCRIPT_DIR/install/config/groups.conf")
configure_user_groups "${groups[@]}"

print_section "Configuring Shell & Terminal"
create_symlink "$DOTFILES_DIR/git/.gitconfig" "$HOME/.gitconfig" ""
run_script "$SCRIPT_DIR/zsh/setup"
run_script "$SCRIPT_DIR/tmux/setup"

print_section "Configuring Applications"
create_symlink "$DOTFILES_DIR/wezterm" "$HOME/.config/wezterm" "config"
create_symlink "$DOTFILES_DIR/nvim" "$HOME/.config/nvim" "config"
create_symlink "$DOTFILES_DIR/starship/starship.toml" "$HOME/.config/starship.toml" "config"
create_symlink "$DOTFILES_DIR/yazi" "$HOME/.config/yazi" "config"
create_symlink "$DOTFILES_DIR/archlinux/xdg-desktop-portal" "$HOME/.config/xdg-desktop-portal" "config"
create_symlink "$DOTFILES_DIR/wallpaper" "$HOME/wallpaper" "config"

run_script "$SCRIPT_DIR/archlinux/hypr/setup"
run_script "$SCRIPT_DIR/archlinux/theme/setup"
run_script "$SCRIPT_DIR/archlinux/dolphin/setup"
run_script "$SCRIPT_DIR/devpod/setup"

print_section "Updating Package List"
update_package_list

print_section "Setup Complete"
