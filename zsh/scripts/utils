#!/usr/bin/env bash

_execute_script() {
    local script_path="$1"
    local use_sudo="$2"

    if [[ ! -f "$script_path" ]]; then
        echo "Error: Script not found: $script_path" >&2
        return 1
    fi

    if [[ ! -x "$script_path" ]]; then
        chmod +x "$script_path" 2>/dev/null
    fi

    ${use_sudo:+sudo} "$script_path"
}

run_script() {
    local script_path="$1"
    _execute_script "$script_path" ""
}

run_sudo_script() {
    local script_path="$1"
    _execute_script "$script_path" "sudo"
}

create_symlink() {
    local source="$1"
    local target="$2"
    local backup_subdir="$3"

    # Check if symlink already exists and points to correct source
    if [ -L "$target" ] && [ "$(readlink "$target")" = "$source" ]; then
        echo "✓ $target -> $source"
        return 0
    fi

    local backup_path="$BACKUP_DIR"
    if [ -n "$backup_subdir" ]; then
        backup_path="$BACKUP_DIR/$backup_subdir"
    fi

    # Create backup directory structure
    mkdir -p "$backup_path"

    # Check if target exists and backup
    if [ -e "$target" ]; then
        echo "Backing up: $target"
        mv "$target" "$backup_path/"
    fi

    # Create parent directory for target if needed
    mkdir -p "$(dirname "$target")"

    # Create symlink
    ln -s "$source" "$target"
    echo "✓ $target -> $source"
}
